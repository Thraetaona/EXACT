<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>EXACT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="title" content="EXACT">
    <meta name="author" content="Fereydoun Memarzanjany">
    <meta name="description" content="Graphical Intel iAPX 86/10 Emulator Written In Pure WebAssembly.">
    <meta name="keywords" content="intel, 8086, iapx, emulator, webassembly, wasm, wat, wast, assembly, browser, cpu, cpu-emulator, 16bit, emulation, graphical, x86, 8086-emulator, 8086-architecture">
    <link rel="stylesheet" type="text/css" href="stylesheet.css" />
  </head>



  <body>
    <h1><code>EXACT</code></h1>
    <p>
      <strong><b>E</b>mulating <b>X</b>86 i<b>A</b>PX <b>C</b>PU on Ne<b>T</b></strong>
    </p>
    <hr>

    <section class="container">
      <span class="label" for="examples">Program:</span>
      <select class="button" id="examples">
        <option selected disabled>Examples</option>
      </select>
      
      <label for="upload" class="button"><input type="file" id="upload" />Choose your own</label>
    </section>

    <!-- Control buttons are disabled until something is available to run -->
    <section class="container" id="control">
      <button class="button" id='run' disabled>Execute</button>
      <button class="button" id='step' disabled>Step</button>
      <button class="button" id='stop' disabled>Halt</button>
    </section>


    <section class="container">
      <section id="registers">
        AX: <var class="register" id="AX">0</var> <br>
        CX: <var class="register" id="CX">0</var> <br>
        DX: <var class="register" id="DX">0</var> <br>
        BX: <var class="register" id="BX">0</var> <br>
        <br>
        SP: <var class="register" id="SP">0</var> <br>
        BP: <var class="register" id="BP">0</var> <br>
        SI: <var class="register" id="SI">0</var> <br>
        DI: <var class="register" id="DI">0</var> <br>
        <br>
        AL: <var class="register" id="AL">0</var> <br>
        AH: <var class="register" id="AH">0</var> <br>
        CL: <var class="register" id="CL">0</var> <br>
        CH: <var class="register" id="CH">0</var> <br>
        <br>
        DL: <var class="register" id="DL">0</var> <br>
        DH: <var class="register" id="DH">0</var> <br>
        BL: <var class="register" id="BL">0</var> <br>
        BH: <var class="register" id="BH">0</var> <br>
        <br>
        ES: <var class="register" id="ES">0</var> <br>
        CS: <var class="register" id="CS">0</var> <br>
        SS: <var class="register" id="SS">0</var> <br>
        DS: <var class="register" id="DS">0</var> <br>
        <br>
        CF: <var class="register" id="CF">0</var> <br>
        PF: <var class="register" id="PF">0</var> <br>
        AF: <var class="register" id="AF">0</var> <br>
        ZF: <var class="register" id="ZF">0</var> <br>
        SF: <var class="register" id="SF">0</var> <br>
        TF: <var class="register" id="TF">0</var> <br>
        IF: <var class="register" id="IF">0</var> <br>
        DF: <var class="register" id="DF">0</var> <br>
        OF: <var class="register" id="OF">0</var> <br>
        <br>
        IP: <var class="register" id="IP">0</var> <br>
      </section>
      <section id="memory">
      </section>
    </section>


    <script type="module" async>
      "use strict";
      import updateUI from './util/ui.js';
      
      (async () => {
        const imports = {
          env: {
            memory: new WebAssembly.Memory({initial: 17, maximum: 17, shared: false}),
          }
        }

        await WebAssembly.instantiateStreaming(fetch('./emulator/8086.wasm'), imports)
        .then(async emulator => {
          document.getElementById('upload').addEventListener('change', function(uploaded) {
            let file = uploaded.target.files[0];
            let reader = new FileReader();
            let ram = new Uint8Array(emulator.instance.exports.memory.buffer);
            
            reader.onload = function() {
              let opcodes = Array.from(new Uint8Array(reader.result));   
              for (let offset = 0; offset < opcodes.byteLength; offset++) {
                ram[offset + 296] = opcodes.getUint8(offset);
              }
            }
            
            reader.readAsArrayBuffer(file);


            for (let offset = 0; offset < 3; offset++) {
              const buttons = document.getElementById("control").children[offset].disabled = false;
            }
          }, false);

          document.getElementById('run').addEventListener('click', function() {
            emulator.instance.exports.start();
          }, false);

          window.setInterval(function(){
            updateUI(emulator.instance);
          }, 1000);
        });
      })();
    </script>
  </body>
</html>